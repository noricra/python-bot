"""
User-Friendly Error Messages - Template System
Solves PROB-019 from UX_AUDIT.md
"""

ERROR_TEMPLATES = {
    'fr': {
        # Product errors
        'product_not_found': {
            'title': '‚ùå PRODUIT INTROUVABLE',
            'message': 'Ce produit n\'existe plus ou a √©t√© supprim√©.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ Parcourir les cat√©gories',
                '‚Ä¢ Utiliser la recherche',
                '‚Ä¢ Contacter le support si le probl√®me persiste'
            ],
            'buttons': ['browse_categories', 'search_product']
        },

        'product_load_error': {
            'title': '‚ùå OUPS, PROBL√àME TECHNIQUE',
            'message': 'Impossible de charger les produits pour le moment.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ R√©essayer dans 1 minute',
                '‚Ä¢ V√©rifier votre connexion',
                '‚Ä¢ Contacter le support si le probl√®me persiste'
            ],
            'buttons': ['retry', 'support']
        },

        'no_products': {
            'title': 'üöß AUCUN PRODUIT DISPONIBLE',
            'message': 'Cette cat√©gorie ne contient pas encore de produits.',
            'actions': [
                'üí° SUGGESTIONS :',
                '‚Ä¢ Explorer d\'autres cat√©gories',
                '‚Ä¢ Revenir plus tard',
                '‚Ä¢ Devenir vendeur et ajouter vos produits'
            ],
            'buttons': ['browse_categories', 'become_seller']
        },

        # Payment errors
        'payment_expired': {
            'title': '‚è∞ PAIEMENT EXPIR√â',
            'message': 'La session de paiement a expir√© (d√©lai: 1 heure).',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ Recommencer l\'achat',
                '‚Ä¢ Si vous avez d√©j√† pay√©, contactez le support avec votre transaction ID'
            ],
            'buttons': ['restart_purchase', 'support']
        },

        'payment_verification_failed': {
            'title': '‚ùå V√âRIFICATION IMPOSSIBLE',
            'message': 'Impossible de v√©rifier le statut du paiement.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ R√©essayer dans quelques secondes',
                '‚Ä¢ V√©rifier votre connexion',
                '‚Ä¢ Ne pas payer plusieurs fois (v√©rifiez d\'abord le statut)'
            ],
            'buttons': ['check_status', 'support']
        },

        'insufficient_balance': {
            'title': 'üí∞ SOLDE INSUFFISANT',
            'message': 'Votre portefeuille n\'a pas assez de fonds pour cette transaction.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ Recharger votre portefeuille crypto',
                '‚Ä¢ V√©rifier l\'adresse de destination',
                '‚Ä¢ Prendre en compte les frais de r√©seau'
            ],
            'buttons': ['retry', 'help']
        },

        # File/Download errors
        'file_not_found': {
            'title': 'üìÅ FICHIER INTROUVABLE',
            'message': 'Le fichier demand√© n\'existe pas ou a √©t√© d√©plac√©.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ V√©rifier votre biblioth√®que',
                '‚Ä¢ Contacter le vendeur',
                '‚Ä¢ Signaler le probl√®me au support'
            ],
            'buttons': ['my_library', 'support']
        },

        'download_failed': {
            'title': '‚ùå T√âL√âCHARGEMENT √âCHOU√â',
            'message': 'Impossible de t√©l√©charger le fichier pour le moment.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ R√©essayer dans quelques secondes',
                '‚Ä¢ V√©rifier votre connexion',
                '‚Ä¢ Contacter le support si le probl√®me persiste'
            ],
            'buttons': ['retry_download', 'support']
        },

        # Permission errors
        'not_authorized': {
            'title': 'üîí ACC√àS REFUS√â',
            'message': 'Vous n\'avez pas l\'autorisation d\'acc√©der √† cette ressource.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ V√©rifier que vous √™tes connect√© au bon compte',
                '‚Ä¢ Acheter le produit si n√©cessaire',
                '‚Ä¢ Contacter le support en cas d\'erreur'
            ],
            'buttons': ['my_account', 'support']
        },

        'seller_only': {
            'title': 'üè™ R√âSERV√â AUX VENDEURS',
            'message': 'Cette fonctionnalit√© est r√©serv√©e aux comptes vendeurs.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ Cr√©er un compte vendeur (gratuit)',
                '‚Ä¢ Se connecter √† votre compte vendeur existant'
            ],
            'buttons': ['become_seller', 'login_seller']
        },

        # Network/Connection errors
        'connection_error': {
            'title': 'üåê PROBL√àME DE CONNEXION',
            'message': 'Impossible de se connecter au serveur.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ V√©rifier votre connexion Internet',
                '‚Ä¢ R√©essayer dans quelques secondes',
                '‚Ä¢ V√©rifier l\'√©tat du service'
            ],
            'buttons': ['retry', 'status_page']
        },

        'timeout': {
            'title': '‚è±Ô∏è D√âLAI D√âPASS√â',
            'message': 'L\'op√©ration a pris trop de temps.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ R√©essayer (parfois le serveur est surcharg√©)',
                '‚Ä¢ V√©rifier votre connexion',
                '‚Ä¢ Signaler si le probl√®me persiste'
            ],
            'buttons': ['retry', 'support']
        },

        # Generic errors
        'generic_error': {
            'title': '‚ùå ERREUR INATTENDUE',
            'message': 'Une erreur inattendue s\'est produite.',
            'actions': [
                'üí° QUE FAIRE ?',
                '‚Ä¢ R√©essayer l\'op√©ration',
                '‚Ä¢ Revenir au menu principal',
                '‚Ä¢ Contacter le support avec une capture d\'√©cran'
            ],
            'buttons': ['retry', 'main_menu', 'support']
        },
    },

    'en': {
        # Product errors
        'product_not_found': {
            'title': '‚ùå PRODUCT NOT FOUND',
            'message': 'This product no longer exists or has been deleted.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Browse categories',
                '‚Ä¢ Use search',
                '‚Ä¢ Contact support if the issue persists'
            ],
            'buttons': ['browse_categories', 'search_product']
        },

        'product_load_error': {
            'title': '‚ùå OOPS, TECHNICAL ISSUE',
            'message': 'Unable to load products at the moment.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Try again in 1 minute',
                '‚Ä¢ Check your connection',
                '‚Ä¢ Contact support if the issue persists'
            ],
            'buttons': ['retry', 'support']
        },

        'no_products': {
            'title': 'üöß NO PRODUCTS AVAILABLE',
            'message': 'This category does not contain any products yet.',
            'actions': [
                'üí° SUGGESTIONS:',
                '‚Ä¢ Explore other categories',
                '‚Ä¢ Come back later',
                '‚Ä¢ Become a seller and add your products'
            ],
            'buttons': ['browse_categories', 'become_seller']
        },

        # Payment errors
        'payment_expired': {
            'title': '‚è∞ PAYMENT EXPIRED',
            'message': 'The payment session has expired (timeout: 1 hour).',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Restart the purchase',
                '‚Ä¢ If you already paid, contact support with your transaction ID'
            ],
            'buttons': ['restart_purchase', 'support']
        },

        'payment_verification_failed': {
            'title': '‚ùå VERIFICATION FAILED',
            'message': 'Unable to verify payment status.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Try again in a few seconds',
                '‚Ä¢ Check your connection',
                '‚Ä¢ Do not pay multiple times (check status first)'
            ],
            'buttons': ['check_status', 'support']
        },

        'insufficient_balance': {
            'title': 'üí∞ INSUFFICIENT BALANCE',
            'message': 'Your wallet does not have enough funds for this transaction.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Reload your crypto wallet',
                '‚Ä¢ Verify the destination address',
                '‚Ä¢ Account for network fees'
            ],
            'buttons': ['retry', 'help']
        },

        # File/Download errors
        'file_not_found': {
            'title': 'üìÅ FILE NOT FOUND',
            'message': 'The requested file does not exist or has been moved.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Check your library',
                '‚Ä¢ Contact the seller',
                '‚Ä¢ Report the issue to support'
            ],
            'buttons': ['my_library', 'support']
        },

        'download_failed': {
            'title': '‚ùå DOWNLOAD FAILED',
            'message': 'Unable to download the file at the moment.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Try again in a few seconds',
                '‚Ä¢ Check your connection',
                '‚Ä¢ Contact support if the issue persists'
            ],
            'buttons': ['retry_download', 'support']
        },

        # Permission errors
        'not_authorized': {
            'title': 'üîí ACCESS DENIED',
            'message': 'You do not have permission to access this resource.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Verify you are logged into the correct account',
                '‚Ä¢ Purchase the product if necessary',
                '‚Ä¢ Contact support if this is an error'
            ],
            'buttons': ['my_account', 'support']
        },

        'seller_only': {
            'title': 'üè™ SELLERS ONLY',
            'message': 'This feature is reserved for seller accounts.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Create a seller account (free)',
                '‚Ä¢ Login to your existing seller account'
            ],
            'buttons': ['become_seller', 'login_seller']
        },

        # Network/Connection errors
        'connection_error': {
            'title': 'üåê CONNECTION ISSUE',
            'message': 'Unable to connect to the server.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Check your Internet connection',
                '‚Ä¢ Try again in a few seconds',
                '‚Ä¢ Check service status'
            ],
            'buttons': ['retry', 'status_page']
        },

        'timeout': {
            'title': '‚è±Ô∏è TIMEOUT',
            'message': 'The operation took too long.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Try again (server may be overloaded)',
                '‚Ä¢ Check your connection',
                '‚Ä¢ Report if the issue persists'
            ],
            'buttons': ['retry', 'support']
        },

        # Generic errors
        'generic_error': {
            'title': '‚ùå UNEXPECTED ERROR',
            'message': 'An unexpected error occurred.',
            'actions': [
                'üí° WHAT TO DO?',
                '‚Ä¢ Try the operation again',
                '‚Ä¢ Return to main menu',
                '‚Ä¢ Contact support with a screenshot'
            ],
            'buttons': ['retry', 'main_menu', 'support']
        },
    }
}


BUTTON_CALLBACKS = {
    'retry': 'retry_last_action',
    'browse_categories': 'browse_categories',
    'search_product': 'search_product',
    'support': 'help_support',
    'become_seller': 'become_seller',
    'restart_purchase': 'buy_menu',
    'check_status': 'check_payment_status',
    'my_library': 'library',
    'my_account': 'settings',
    'main_menu': 'main_menu',
    'help': 'help_menu',
    'retry_download': 'retry_download',
    'login_seller': 'seller_login',
    'status_page': 'system_status',
}


BUTTON_LABELS = {
    'fr': {
        'retry': 'üîÑ R√©essayer',
        'browse_categories': 'üìÇ Cat√©gories',
        'search_product': 'üîç Rechercher',
        'support': 'üí¨ Support',
        'become_seller': 'üè™ Devenir vendeur',
        'restart_purchase': 'üîÑ Recommencer',
        'check_status': 'üîç V√©rifier statut',
        'my_library': 'üìö Ma biblioth√®que',
        'my_account': '‚öôÔ∏è Mon compte',
        'main_menu': 'üè† Menu principal',
        'help': '‚ùì Aide',
        'retry_download': 'üîÑ Ret√©l√©charger',
        'login_seller': 'üîë Connexion vendeur',
        'status_page': 'üìä √âtat du service',
    },
    'en': {
        'retry': 'üîÑ Try Again',
        'browse_categories': 'üìÇ Categories',
        'search_product': 'üîç Search',
        'support': 'üí¨ Support',
        'become_seller': 'üè™ Become Seller',
        'restart_purchase': 'üîÑ Restart',
        'check_status': 'üîç Check Status',
        'my_library': 'üìö My Library',
        'my_account': '‚öôÔ∏è My Account',
        'main_menu': 'üè† Main Menu',
        'help': '‚ùì Help',
        'retry_download': 'üîÑ Re-download',
        'login_seller': 'üîë Seller Login',
        'status_page': 'üìä Service Status',
    }
}


def get_error_message(error_type: str, lang: str = 'fr', custom_message: str = None) -> dict:
    """
    Get user-friendly error message with actions and buttons

    Args:
        error_type: Error type key (e.g., 'product_not_found')
        lang: Language ('fr' or 'en')
        custom_message: Optional custom message to override default

    Returns:
        dict: {
            'text': Formatted error message,
            'keyboard': InlineKeyboardMarkup with action buttons
        }
    """
    from telegram import InlineKeyboardButton, InlineKeyboardMarkup

    # Get template
    template = ERROR_TEMPLATES.get(lang, ERROR_TEMPLATES['fr']).get(
        error_type,
        ERROR_TEMPLATES[lang]['generic_error']
    )

    # Build message text
    text_parts = [
        template['title'],
        '',
        custom_message or template['message'],
        '',
        *template['actions']
    ]

    text = '\n'.join(text_parts)

    # Build keyboard
    keyboard = []
    button_labels = BUTTON_LABELS.get(lang, BUTTON_LABELS['fr'])

    for button_key in template.get('buttons', []):
        callback_data = BUTTON_CALLBACKS.get(button_key, 'main_menu')
        label = button_labels.get(button_key, button_key)

        keyboard.append([InlineKeyboardButton(label, callback_data=callback_data)])

    # Always add back button
    keyboard.append([
        InlineKeyboardButton(
            'üîô Retour' if lang == 'fr' else 'üîô Back',
            callback_data='main_menu'
        )
    ])

    return {
        'text': text,
        'keyboard': InlineKeyboardMarkup(keyboard)
    }


def send_error_message(bot, query_or_message, error_type: str, lang: str = 'fr', custom_message: str = None):
    """
    Convenience function to send error message directly

    Args:
        bot: Bot instance
        query_or_message: CallbackQuery or Message object
        error_type: Error type key
        lang: Language
        custom_message: Optional custom message
    """
    error_data = get_error_message(error_type, lang, custom_message)

    # Detect if it's a callback query or message
    if hasattr(query_or_message, 'edit_message_text'):
        # It's a CallbackQuery
        try:
            return query_or_message.edit_message_text(
                text=error_data['text'],
                reply_markup=error_data['keyboard'],
                parse_mode='Markdown'
            )
        except:
            # Fallback: send new message
            return query_or_message.message.reply_text(
                text=error_data['text'],
                reply_markup=error_data['keyboard'],
                parse_mode='Markdown'
            )
    else:
        # It's a Message
        return query_or_message.reply_text(
            text=error_data['text'],
            reply_markup=error_data['keyboard'],
            parse_mode='Markdown'
        )
